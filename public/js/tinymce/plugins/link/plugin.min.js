tinymce.PluginManager.add("link",function(a){function c(a){return a&&"A"===a.nodeName&&a.href}function d(a){return tinymce.util.Tools.grep(a,c).length>0}function e(b){return a.dom.getParent(b,"a[href]")}function f(){return e(a.selection.getStart())}function g(a){var b=a.getAttribute("data-mce-href");return b?b:a.getAttribute("href")}function h(){var b=a.plugins.contextmenu;return!!b&&b.isContextMenuVisible()}function j(b){var d,e,f;return!!(a.settings.link_context_toolbar&&!h()&&c(b)&&(d=a.selection,e=d.getRng(),f=e.startContainer,3==f.nodeType&&d.isCollapsed()&&e.startOffset>0&&e.startOffset<f.data.length))}function k(a,b){document.body.appendChild(a),a.dispatchEvent(b),document.body.removeChild(a)}function l(a){if(!tinymce.Env.ie||tinymce.Env.ie>10){var b=document.createElement("a");b.target="_blank",b.href=a,b.rel="noreferrer noopener";var c=document.createEvent("MouseEvents");c.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),k(b,c)}else{var d=window.open("","_blank");if(d){d.opener=null;var e=d.document;e.open(),e.write('<meta http-equiv="refresh" content="0; url='+tinymce.DOM.encode(a)+'">'),e.close()}}}function m(b){if(b){var c=g(b);if(/^#/.test(c)){var d=a.$(c);d.length&&a.selection.scrollIntoView(d[0],!0)}else l(b.href)}}function n(){m(f())}function o(){var b=this,c=function(a){d(a.parents)?b.show():b.hide()};d(a.dom.getParents(a.selection.getStart()))||b.hide(),a.on("nodechange",c),b.on("remove",function(){a.off("nodechange",c)})}function p(b){return function(){var c=a.settings.link_list;"string"==typeof c?tinymce.util.XHR.send({url:c,success:function(a){b(tinymce.util.JSON.parse(a))}}):"function"==typeof c?c(b):b(c)}}function q(a,b,c){function d(a,c){return c=c||[],tinymce.each(a,function(a){var e={text:a.text||a.title};a.menu?e.menu=d(a.menu):(e.value=a.value,b&&b(e)),c.push(e)}),c}return d(a,c||[])}function r(c){function t(a){var b=j.find("#text");(!b.value()||a.lastControl&&b.value()==a.lastControl.text())&&b.value(a.control.text()),j.find("#href").value(a.control.value())}function u(b){var c=[];if(tinymce.each(a.dom.select("a:not([href])"),function(a){var d=a.name||a.id;d&&c.push({text:d,value:"#"+d,selected:b.indexOf("#"+d)!=-1})}),c.length)return c.unshift({text:"None",value:""}),{name:"anchor",type:"listbox",label:"Anchors",values:c,onselect:t}}function v(){!i&&0===d.text.length&&k&&this.parent().parent().find("#text")[0].value(this.value())}function w(c){var e=c.meta||{};m&&m.value(a.convertURL(this.value(),"href")),tinymce.each(c.meta,function(a,b){var c=j.find("#"+b);"text"===b?0===i.length&&(c.value(a),d.text=a):c.value(a)}),e.attach&&(b={href:this.value(),attach:e.attach}),e.text||v.call(this)}function x(a){var b=e.getContent();if(/</.test(b)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(b)||b.indexOf("href=")==-1))return!1;if(a){var d,c=a.childNodes;if(0===c.length)return!1;for(d=c.length-1;d>=0;d--)if(3!=c[d].nodeType)return!1}return!0}function y(a){a.meta=j.toJSON()}var g,h,i,j,k,l,m,n,o,p,r,s,d={},e=a.selection,f=a.dom;g=e.getNode(),h=f.getParent(g,"a[href]"),k=x(),d.text=i=h?h.innerText||h.textContent:e.getContent({format:"text"}),d.href=h?f.getAttrib(h,"href"):"",h?d.target=f.getAttrib(h,"target"):a.settings.default_link_target&&(d.target=a.settings.default_link_target),(s=f.getAttrib(h,"rel"))&&(d.rel=s),(s=f.getAttrib(h,"class"))&&(d.class=s),(s=f.getAttrib(h,"title"))&&(d.title=s),k&&(l={name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){d.text=this.value()}}),c&&(m={type:"listbox",label:"Link list",values:q(c,function(b){b.value=a.convertURL(b.value||b.url,"href")},[{text:"None",value:""}]),onselect:t,value:a.convertURL(d.href,"href"),onPostRender:function(){m=this}}),a.settings.target_list!==!1&&(a.settings.target_list||(a.settings.target_list=[{text:"None",value:""},{text:"New window",value:"_blank"}]),o={name:"target",type:"listbox",label:"Target",values:q(a.settings.target_list)}),a.settings.rel_list&&(n={name:"rel",type:"listbox",label:"Rel",values:q(a.settings.rel_list)}),a.settings.link_class_list&&(p={name:"class",type:"listbox",label:"Class",values:q(a.settings.link_class_list,function(b){b.value&&(b.textStyle=function(){return a.formatter.getCssText({inline:"a",classes:[b.value]})})})}),a.settings.link_title!==!1&&(r={name:"title",type:"textbox",label:"Title",value:d.title}),j=a.windowManager.open({title:"Insert link",data:d,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url",onchange:w,onkeyup:v,onbeforecall:y},l,r,u(d.href),m,n,o,p],onSubmit:function(c){function j(b,c){var d=a.selection.getRng();tinymce.util.Delay.setEditorTimeout(a,function(){a.windowManager.confirm(b,function(b){a.selection.setRng(d),c(b)})})}function l(a,b){function d(a){return a=e(a),a?[a,c].join(" "):c}function e(a){var b=new RegExp("("+c.replace(" ","|")+")","g");return a&&(a=tinymce.trim(a.replace(b,""))),a?a:null}var c="noopener noreferrer";return b?d(a):e(a)}function m(){var c={href:g,target:d.target?d.target:null,rel:d.rel?d.rel:null,class:d.class?d.class:null,title:d.title?d.title:null};a.settings.allow_unsafe_link_target||(c.rel=l(c.rel,"_blank"==c.target)),g===b.href&&(b.attach(),b={}),h?(a.focus(),k&&d.text!=i&&("innerText"in h?h.innerText=d.text:h.textContent=d.text),f.setAttribs(h,c),e.select(h),a.undoManager.add()):k?a.insertContent(f.createHTML("a",c,f.encode(d.text))):a.execCommand("mceInsertLink",!1,c)}function n(){a.undoManager.transact(m)}var g;return d=tinymce.extend(d,c.data),(g=d.href)?g.indexOf("@")>0&&g.indexOf("//")==-1&&g.indexOf("mailto:")==-1?void j("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(a){a&&(g="mailto:"+g),n()}):a.settings.link_assume_external_targets&&!/^\w+:/i.test(g)||!a.settings.link_assume_external_targets&&/^\s*www[\.|\d\.]/i.test(g)?void j("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(a){a&&(g="http://"+g),n()}):void n():void a.execCommand("unlink")}});var z=jQuery(a.editorContainer).position(),A=z.left,B=z.top;j.moveTo(A,B)}var b={},i=function(a){return a.altKey===!0&&a.shiftKey===!1&&a.ctrlKey===!1&&a.metaKey===!1};a.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Meta+K",onclick:p(r),stateSelector:"a[href]"}),a.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"}),a.addContextToolbar&&(a.addButton("openlink",{icon:"newtab",tooltip:"Open link",onclick:n}),a.addContextToolbar(j,"openlink | link unlink")),a.addShortcut("Meta+K","",p(r)),a.addCommand("mceLink",p(r)),a.on("click",function(a){var b=e(a.target);b&&tinymce.util.VK.metaKeyPressed(a)&&(a.preventDefault(),m(b))}),a.on("keydown",function(a){var b=f();b&&13===a.keyCode&&i(a)&&(a.preventDefault(),m(b))}),this.showDialog=r,a.addMenuItem("openlink",{text:"Open link",icon:"newtab",onclick:n,onPostRender:o,prependToContext:!0}),a.addMenuItem("link",{icon:"link",text:"Link",shortcut:"Meta+K",onclick:p(r),stateSelector:"a[href]",context:"insert",prependToContext:!0})});